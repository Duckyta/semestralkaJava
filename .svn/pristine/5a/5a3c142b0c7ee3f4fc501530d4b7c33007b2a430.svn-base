package gui;

import firma.Firma;
import firma.IFirma;
import pobocka.IPobocka;
import firma.IZamestnanec;
import java.io.IOException;
import java.net.URL;
import java.util.Iterator;
import java.util.ResourceBundle;
import java.util.logging.Level;
import java.util.logging.Logger;
import javafx.beans.value.ObservableValue;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.Initializable;
import javafx.scene.control.Alert;
import javafx.scene.control.ButtonType;
import javafx.scene.control.Label;
import javafx.scene.control.ListView;
import javafx.scene.control.TextField;
import pomocne.Soubory;

/**
 *
 * @author DuckMcQuack
 */
public class FXMLDocumentController implements Initializable {

    private IFirma firma;
    private IPobocka pobocka;
    IZamestnanec zamestnanec;
    Object[] poleZamestnanec = null;
    Object[] polePobocek = null;

    private ObservableList<IPobocka> obsPobocky;
    private ObservableList<IZamestnanec> obsZamestnanci;
    private ObservableList<IPobocka> pobockyOLHeap;
    private ObservableList<IZamestnanec> zamestnanciOLpom;

    @FXML
    private TextField textFieldIndexSyna;

    @FXML
    private Label label;

    @FXML
    private ListView<IPobocka> listViewPobocky;

    @FXML
    private ListView<IZamestnanec> listViewZamestnanci;

    @FXML
    private void handleUloz(ActionEvent event) {
        try {
            Soubory.uloz("data.bin", firma);
            zprava(Alert.AlertType.INFORMATION, "Uložení proběhlo v pořádku!",
                    "Uložení", ButtonType.OK);

        } catch (IOException ex) {
            Logger.getLogger(FXMLDocumentController.class.getName()).
                    log(Level.SEVERE, null, ex);
        }
    }

    @FXML
    private void handleNacti(ActionEvent event) {
        try {
            Soubory.nactiSerialize("data.bin", firma);
            zobrazPobocky();
            zprava(Alert.AlertType.INFORMATION, "Načtení proběhlo v pořádku!",
                    "Načtení", ButtonType.OK);
        } catch (IOException ex) {
            Logger.getLogger(FXMLDocumentController.class.getName()).log(Level.SEVERE, null, ex);
        }
    }

    //---------------OPERACE POBOCKA---------------//
    @FXML
    private void handlePridejPobocku(ActionEvent event) {
        DialogPridejPobocku dlg = new DialogPridejPobocku(label.getScene().getWindow(), firma);
        dlg.showAndWait();
        zobrazPobocky();
    }

    @FXML
    private void handleOdeberPobocku(ActionEvent event) {
        pobocka = listViewPobocky.getSelectionModel().getSelectedItem();
        if (pobocka != null) {
            firma.odeber(pobocka.getNazev());
            zobrazPobocky();
        } else {
            zprava(Alert.AlertType.ERROR,
                    "Nejdříve vyberte pobočku, kterou chcete odstranit!",
                    "POZOR!",
                    ButtonType.OK);
        }

    }

    //---------------OPERACE ZAMESTNANEC---------------//
    @FXML
    private void handlePridejZamestnance(ActionEvent event) {
        pobocka = listViewPobocky.getSelectionModel().getSelectedItem();
        if (pobocka != null) {
            DialogPridejZamestnance dlg = new DialogPridejZamestnance(label.getScene().getWindow(), pobocka);
            dlg.showAndWait();
            zobrazPobocky();
            zobrazZamestnance();
        } else {
            zprava(Alert.AlertType.ERROR,
                    "Nejdříve vyberte pobočku, které chcete přidat zaměstnance",
                    "POZOR!",
                    ButtonType.OK);
        }

    }

    @FXML
    private void handleOdeberZamestnance(ActionEvent event) {
        pobocka = listViewPobocky.getSelectionModel().getSelectedItem();
        if (pobocka != null) {
            pobocka.odeber(listViewZamestnanci.getSelectionModel().getSelectedItem());
            zobrazZamestnance();
        } else {
            zprava(Alert.AlertType.ERROR,
                    "Nejdříve vyberte pobočku, které chcete přidat zaměstnance",
                    "POZOR!",
                    ButtonType.OK);
        }

    }

    //---------------OPERACE ZPRISTUPNI---------------//
    @FXML
    private void handleZpristupniKoren(ActionEvent event) {
        pobocka = listViewPobocky.getSelectionModel().getSelectedItem();
        if (pobocka != null) {
            listViewZamestnanci.getSelectionModel().select(pobocka.zpristupniVedoucihoPobocky());
        } else {
            zprava(Alert.AlertType.ERROR,
                    "Nejdříve vyberte pobočku!",
                    "POZOR!",
                    ButtonType.OK);
        }
    }

    @FXML
    private void handleZpristupniOtce(ActionEvent event) {
        pobocka = listViewPobocky.getSelectionModel().getSelectedItem();
        if (pobocka != null) {
            try {
                int index = Integer.parseInt(textFieldIndexSyna.getText());
                listViewZamestnanci.getSelectionModel().select(pobocka.zpristupniVedoucihoOddeleni(index));
            } catch (NumberFormatException | NullPointerException ex) {
            }
        } else {
            zprava(Alert.AlertType.ERROR,
                    "Nejdříve vyberte pobočku!",
                    "POZOR!",
                    ButtonType.OK);
        }
    }

    @FXML
    private void handleZpristupniSyna(ActionEvent event) {
        pobocka = listViewPobocky.getSelectionModel().getSelectedItem();
        if (pobocka != null) {
            try {
                int index = Integer.parseInt(textFieldIndexSyna.getText());
                listViewZamestnanci.getSelectionModel().select(pobocka.zpristupni(index));
            } catch (NumberFormatException | NullPointerException ex) {
            }
        } else {
            zprava(Alert.AlertType.ERROR,
                    "Nejdříve vyberte pobočku!",
                    "POZOR!",
                    ButtonType.OK);
        }
    }

    //---------------HEAP-------------------------//
    @FXML
    private void poleHeap(ActionEvent event) throws IOException {
        //vytvorPole();
    }

    //---------------OPERACE ODEBER---------------//
    @FXML
    private void handleOdeberKoren(ActionEvent event) {
        pobocka = listViewPobocky.getSelectionModel().getSelectedItem();
        if (pobocka != null) {
            try {
                int index = Integer.parseInt(textFieldIndexSyna.getText());
                listViewZamestnanci.getSelectionModel().select(pobocka.zpristupni(index));
            } catch (NumberFormatException | NullPointerException ex) {
            }
        } else {
            zprava(Alert.AlertType.ERROR,
                    "Nejdříve vyberte pobočku!",
                    "POZOR!",
                    ButtonType.OK);
        }
    }

    @Override
    public void initialize(URL url, ResourceBundle rb) {
        firma = new Firma("DuckMcQuack s.r.o");
        //vybranaPobocka = null;
        obsPobocky = FXCollections.observableArrayList();
        obsZamestnanci = FXCollections.observableArrayList();
        label.setText(firma.getNazevFirmy());

        // Listener
        listViewPobocky.getSelectionModel().selectedItemProperty().addListener((ObservableValue<? extends IPobocka> observable, IPobocka oldValue, IPobocka newValue) -> {
            zobrazZamestnance();
        });
    }

    //---------------POMOCNE METODY---------------//
    private void zobrazPobocky() {
        obsPobocky.clear();
        Iterator<IPobocka> it = firma.iterator();
        while (it.hasNext()) {
            obsPobocky.add(it.next());
        }

        listViewPobocky.setItems(obsPobocky);
    }

    private void zobrazZamestnance() {
        if (pobocka != null) {
            obsZamestnanci.clear();
            if (pobocka.getPocetZamestnancu() > 0) {
                Iterator<IZamestnanec> it = pobocka.iterator();

                while (it.hasNext()) {
                    obsZamestnanci.add(it.next());
                }
                listViewZamestnanci.setItems(obsZamestnanci);
            }
        }
    }

    private void zprava(Alert.AlertType typ, String zprava, String nadpis, ButtonType btnType) {
        Alert alert = new Alert(typ, zprava, btnType);
        alert.setHeaderText(nadpis);
        alert.showAndWait();
    }

}
